<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance System - Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

      body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80')
          no-repeat center center;
        background-size: cover;
        position: relative;
        overflow: hidden;
      }

      body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.85);
        z-index: 0;
      }

      .login-container {
        width: 420px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        position: relative;
        z-index: 1;
        transform: translateY(0);
        transition: transform 0.4s ease, box-shadow 0.4s ease;
      }

      .login-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .login-header {
        background: #1a3e8c;
        color: white;
        padding: 28px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .login-header h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
        position: relative;
        z-index: 1;
      }

      .login-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: #e63946;
      }

      .login-content {
        padding: 30px 40px;
      }

      .form-group {
        margin-bottom: 25px;
        position: relative;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 0.95rem;
      }

      .form-control {
        width: 100%;
        padding: 14px 18px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s;
        box-sizing: border-box;
        background: #f9f9f9;
      }

      .form-control:focus {
        border-color: #1a3e8c;
        box-shadow: 0 0 0 3px rgba(26, 62, 140, 0.1);
        outline: none;
        background: white;
      }

      .btn-login {
        width: 100%;
        padding: 14px;
        background: #1a3e8c;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 10px;
        position: relative;
        overflow: hidden;
      }

      .btn-login::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: 0.5s;
      }

      .btn-login:hover {
        background: #0d2b66;
      }

      .btn-login:hover::before {
        left: 100%;
      }

      .login-footer {
        text-align: center;
        padding: 20px;
        border-top: 1px solid #eee;
        font-size: 0.9rem;
        color: #666;
      }

      .login-footer a {
        color: #1a3e8c;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
      }

      .login-footer a:hover {
        color: #e63946;
      }

      .university-logo {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        background: #e63946;
        border-radius: 60%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .remember-forgot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .remember-me {
        display: flex;
        align-items: center;
      }

      .remember-me input {
        margin-right: 8px;
      }

      .forgot-password a {
        color: #e63946;
        text-decoration: none;
        font-size: 0.9rem;
      }

      .error-message {
        color: #e63946;
        font-size: 0.8rem;
        margin-top: 5px;
        display: block;
        transition: all 0.3s ease;
      }

      .form-control.is-invalid {
        border-color: #e63946;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23e63946' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23e63946' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      .form-control.is-valid {
        border-color: #28a745;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      }

      /* OTP input styling */
      .otp-input {
        width: 70px;
        height: 50px;
        text-align: center;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <div class="university-logo">U</div>
      <div class="login-header">
        <h2>Attendance recording system</h2>
      </div>
      <div class="login-content">
        <form id="loginForm">
          <div class="form-group">
            <label for="admission_number">Admission number</label>
            <input
              type="text"
              name="admission_number"
              id="admission_number"
              class="form-control"
              placeholder="e.g. BUS-231-040/2023"
            />
            <span id="admission_number_error" class="error-message"></span>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              name="password"
              id="password"
              class="form-control"
              placeholder="Enter your password"
            />
            <span id="password_error" class="error-message"></span>
          </div>
          <div class="remember-forgot">
            <div class="remember-me">
              <input type="checkbox" id="remember" />
              <label for="remember">Remember me</label>
            </div>
            <div class="forgot-password">
              <a href="#">Forgot password?</a>
            </div>
          </div>
          <button type="submit" class="btn-login">Sign In</button>
        </form>
      </div>
      <div class="login-footer">
        <p>Don't have an account? <a href="signup.html">Sign up</a></p>
      </div>
    </div>

    <!-- OTP Verification Modal -->
    <div
      class="modal fade"
      id="otpVerificationModal"
      tabindex="-1"
      aria-labelledby="otpVerificationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="otpForm">
            <div class="modal-header">
              <h5 class="modal-title" id="otpVerificationModalLabel">
                OTP Verification
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <p>Please enter the OTP sent to your registered email.</p>
              <div class="d-flex justify-content-center gap-2">
                <input
                  type="text"
                  class="form-control otp-input"
                  maxlength="1"
                  id="otp1"
                  oninput="moveToNext(this, 'otp2')"
                />
                <input
                  type="text"
                  class="form-control otp-input"
                  maxlength="1"
                  id="otp2"
                  oninput="moveToNext(this, 'otp3')"
                  onkeydown="moveToPrevious(event, 'otp1')"
                />
                <input
                  type="text"
                  class="form-control otp-input"
                  maxlength="1"
                  id="otp3"
                  oninput="moveToNext(this, 'otp4')"
                  onkeydown="moveToPrevious(event, 'otp2')"
                />
                <input
                  type="text"
                  class="form-control otp-input"
                  maxlength="1"
                  id="otp4"
                  oninput="moveToNext(this, 'otp5')"
                  onkeydown="moveToPrevious(event, 'otp3')"
                />
                <input
                  type="text"
                  class="form-control otp-input"
                  maxlength="1"
                  id="otp5"
                  oninput="moveToNext(this, 'otp6')"
                  onkeydown="moveToPrevious(event, 'otp4')"
                />
                <input
                  type="text"
                  class="form-control otp-input"
                  maxlength="1"
                  id="otp6"
                  onkeydown="moveToPrevious(event, 'otp5')"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Verify OTP</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const loginForm = document.getElementById('loginForm');
        const otpForm = document.getElementById('otpForm');
        const admissionNumberInput =
          document.getElementById('admission_number');
        const passwordInput = document.getElementById('password');
        const admissionNumberError = document.getElementById(
          'admission_number_error'
        );
        const passwordError = document.getElementById('password_error');

        // Get current year
        const currentYear = new Date().getFullYear();

        // List of valid faculties
        const validFaculties = ['CIT', 'BUS', 'MCS', 'SCT', 'SST', 'ENG'];

        // Validation rules
        const validations = {
          admission_number: {
            required: true,
            custom: (value) => {
              // Format BUS-242-128/2022
              const regex = /^([A-Z]{3})-(\d{3})-(\d{3})\/(\d{4})$/;
              const match = value.match(regex);

              if (!match) {
                return {
                  valid: false,
                  message:
                    'Format should be XXX-000-000/0000 (e.g. BUS-242-128/2022)',
                };
              }

              const [, faculty, , , year] = match;

              // Check if faculty is valid
              if (!validFaculties.includes(faculty)) {
                return {
                  valid: false,
                  message: `Faculty must be one of: ${validFaculties.join(
                    ', '
                  )}`,
                };
              }

              // Check if year is valid (less than current year)
              const yearNum = parseInt(year);
              if (yearNum >= currentYear) {
                return {
                  valid: false,
                  message: `Year must be less than current year (${currentYear})`,
                };
              }

              return { valid: true };
            },
            messages: {
              required: 'Admission number is required',
            },
          },
          password: {
            required: true,
            minLength: 6,
            messages: {
              required: 'Password is required',
              minLength: 'Password must be at least 6 characters long',
            },
          },
        };

        // Validate a single field
        const validateField = (field, value) => {
          const rules = validations[field];
          const errorElement = document.getElementById(`${field}_error`);
          const inputElement = document.getElementById(field);

          // Reset validation state
          errorElement.textContent = '';
          inputElement.classList.remove('is-invalid', 'is-valid');

          // Check required
          if (rules.required && !value.trim()) {
            errorElement.textContent = rules.messages.required;
            inputElement.classList.add('is-invalid');
            return false;
          }

          // Check custom validation if exists
          if (rules.custom) {
            const result = rules.custom(value);
            if (!result.valid) {
              errorElement.textContent = result.message;
              inputElement.classList.add('is-invalid');
              return false;
            }
          }

          // Check minLength if exists
          if (rules.minLength && value.length < rules.minLength) {
            errorElement.textContent = rules.messages.minLength;
            inputElement.classList.add('is-invalid');
            return false;
          }

          inputElement.classList.add('is-valid');
          return true;
        };

        // Handle input changes for real-time validation
        const handleInputChange = (e) => {
          const { name, value } = e.target;
          validateField(name, value);
        };

        // Add input event listeners for real-time validation
        admissionNumberInput.addEventListener('input', handleInputChange);
        passwordInput.addEventListener('input', handleInputChange);

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          // Validate all fields
          const admissionNumberValid = validateField(
            'admission_number',
            admissionNumberInput.value
          );
          const passwordValid = validateField('password', passwordInput.value);

          // If all validations pass, proceed with login
          if (admissionNumberValid && passwordValid) {
            // Get the login button and disable it
            const loginButton = document.querySelector('.btn-login');
            const originalButtonText = loginButton.textContent;
            loginButton.textContent = 'Processing...';
            loginButton.disabled = true;
            loginButton.style.cursor = 'not-allowed';

            try {
              const response = await fetch(
                'http://localhost:3000/api/auth/login',
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    admission_number: admissionNumberInput.value,
                    password: passwordInput.value,
                  }),
                }
              );

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Login failed');
              }

              const data = await response.json();
              console.log('Login successful:', data);

              // Show the OTP modal
              const otpModal = new bootstrap.Modal(
                document.getElementById('otpVerificationModal')
              );
              otpModal.show();
            } catch (err) {
              console.error('Login error:', err);
              alert(err.message || 'An error occurred during login');
            } finally {
              // Re-enable the button and restore original text
              loginButton.textContent = originalButtonText;
              loginButton.disabled = false;
              loginButton.style.cursor = '';
            }
          }
        });

        // OTP form submission
        otpForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          // Collect the OTP from the input boxes
          const otp =
            document.getElementById('otp1').value +
            document.getElementById('otp2').value +
            document.getElementById('otp3').value +
            document.getElementById('otp4').value +
            document.getElementById('otp5').value +
            document.getElementById('otp6').value;

          if (otp.length !== 6) {
            alert('Please enter a valid 6-digit OTP.');
            return;
          }

          // Get the submit button
          const submitButton = otpForm.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.textContent = 'Processing...';

          try {
            const response = await fetch(
              'http://localhost:3000/api/auth/verify_otp',
              {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  otp,
                  admission_number: admissionNumberInput.value,
                }),
              }
            );
            console.log(response);

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'OTP verification failed');
            }

            const result = await response.json();
            console.log('OTP verification successful:', result);

            // Store user data in localStorage
            localStorage.setItem(
              'admission_number',
              admissionNumberInput.value
            );
            localStorage.setItem('user_data', JSON.stringify(result.user));

            // Close the modal
            const otpModal = bootstrap.Modal.getInstance(
              document.getElementById('otpVerificationModal')
            );
            otpModal.hide();

            // Redirect to attendance page
            window.location.href = 'attendance.html';
          } catch (error) {
            console.error('Error verifying OTP:', error);
            alert(
              error.message || 'An error occurred while verifying the OTP.'
            );
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Verify OTP';
          }
        });

        // OTP input navigation functions
        window.moveToNext = (current, nextId) => {
          if (current.value.length === 1 && nextId) {
            document.getElementById(nextId).focus();
          }
        };

        window.moveToPrevious = (event, prevId) => {
          if (event.key === 'Backspace' && !event.target.value && prevId) {
            document.getElementById(prevId).focus();
          }
        };

        // Check admission number availability
        let debounceTimer;
        admissionNumberInput.addEventListener('input', function (e) {
          handleInputChange(e);
          clearTimeout(debounceTimer);

          debounceTimer = setTimeout(async () => {
            const admissionNumber = e.target.value;

            if (validateField('admission_number', admissionNumber)) {
              try {
                const encodedAdmissionNumber =
                  encodeURIComponent(admissionNumber);
                const response = await fetch(
                  `http://localhost:3000/api/auth/user/check-admission/${encodedAdmissionNumber}`,
                  {
                    method: 'GET',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                  }
                );

                if (!response.ok) {
                  admissionNumberError.textContent =
                    'User not found. Please check your admission number.';
                  admissionNumberInput.classList.add('is-invalid');
                }
              } catch (err) {
                console.error('Error checking admission number:', err);
              }
            }
          }, 500);
        });
      });
    </script>
  </body>
</html>
